function getColorInfo(r){for(var t=r.height,o=r.width,e=r.data,g=0,n=new Object,h=0;t>h;h++)for(var s=0;o>s;s++){var l=e[g]+","+e[g+1]+","+e[g+2];n[l]?n[l]+=1:n[l]=1,g+=4}var a,i=new Array;for(var l in n)a=l.split(","),i[i.length]={r:parseInt(a[0],10),g:parseInt(a[1],10),b:parseInt(a[2],10),uses:n[l]};return i}function TMedianCut(r,t){this.raw=r.data,this.width=r.width,this.height=r.height,this.msg="",this.colors=t}TMedianCut.prototype={_setProperty:function(r){for(var t=0,o=0,e=0,g=0,n=255,h=255,s=255,l=0;l<r.length;l++)r[l].rgb.r>o&&(o=r[l].rgb.r),r[l].rgb.g>e&&(e=r[l].rgb.g),r[l].rgb.b>g&&(g=r[l].rgb.b),r[l].rgb.r<n&&(n=r[l].rgb.r),r[l].rgb.g<h&&(h=r[l].rgb.g),r[l].rgb.b<s&&(s=r[l].rgb.b),t+=r[l].rgb.uses;var a=1.2*(o-n),i=1.2*(e-h),b=g-s,c="r";return a>i&&a>b&&(c="r"),i>a&&i>b&&(c="g"),b>a&&b>i&&(c="b"),{color:r,total:t,type:c}},_MedianCut:function(r,t){for(var o=0,e=0,g=0;g<r.length;g++)r[g].total>o&&1!=r[g].color.length&&(e=g,o=r[g].total);if(1==r[e].total)return this.msg+=t+"色までキューブを分割できませんでした。\n",r;if(1==r[e].color.length)return this.msg+=t+"色までキューブを分割できませんでした。\n",r;var n=r[e].type;r[e].color.sort(function(r,t){return r.rgb[n]<t.rgb[n]?-1:r.rgb[n]>t.rgb[n]?1:0}),split_border=Math.floor((r[e].color.length+1)/2);for(var h=new Array,s=new Array,g=0;g<r[e].color.length;g++)g<split_border?h[h.length]=r[e].color[g]:s[s.length]=r[e].color[g];h=this._setProperty(h),s=this._setProperty(s);for(var l=new Array,g=0;g<r.length;g++)g!=e&&(l[l.length]=r[g]);return l[l.length]=h,l[l.length]=s,l.length<t?this._MedianCut(l,t):l},run:function(r,t){this.colors.length<=r&&(this.msg="既に"+this.colors.length+"色に減色されています。\n");for(var o=new Array,e=0;e<this.colors.length;e++)o[o.length]={rgb:this.colors[e]};var g=new Array;g[0]=this._setProperty(o);for(var n=this._MedianCut(g,r),h=new Array,e=0;e<n.length;e++){for(var s=0,l=0,a=0,i=0,b=0;b<n[e].color.length;b++)l+=n[e].color[b].rgb.r*n[e].color[b].rgb.uses,a+=n[e].color[b].rgb.g*n[e].color[b].rgb.uses,i+=n[e].color[b].rgb.b*n[e].color[b].rgb.uses,s+=n[e].color[b].rgb.uses;h[e]={r:Math.round(l/s),g:Math.round(a/s),b:Math.round(i/s)}}if(this.rep_color=h,t){for(var c=new Object,e=0;e<n.length;e++)for(var b=0;b<n[e].color.length;b++)c[n[e].color[b].rgb.r+","+n[e].color[b].rgb.g+","+n[e].color[b].rgb.b]={r:h[e].r,g:h[e].g,b:h[e].b};for(var u,f=0,e=0;e<this.height;e++)for(var b=0;b<this.width;b++)u=this.raw[f]+","+this.raw[f+1]+","+this.raw[f+2],this.raw[f]=c[u].r,this.raw[f+1]=c[u].g,this.raw[f+2]=c[u].b,f+=4}}};